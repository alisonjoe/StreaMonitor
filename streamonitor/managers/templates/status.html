<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>直播下载任务状态</title>

    <!-- 引入Bootstrap和jQuery库 -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
</head>
<body>

    <h1>直播下载任务状态</h1>
    <button class="btn btn-primary" data-toggle="modal" data-target="#addStreamerModal">添加直播间</button>
    
    <!-- 模态框 -->
    <div class="modal fade" id="addStreamerModal" tabindex="-1" role="dialog" aria-labelledby="addStreamerModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addStreamerModalLabel">添加直播间</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- 表单 -->
                    <form id="addStreamerForm">
                        <div class="form-group">
                            <label for="streamerName">主播名字</label>
                            <input type="text" class="form-control" id="streamerName" placeholder="输入主播名字">
                        </div>
                        <div class="form-group">
                            <label for="platformSelect">平台</label>
                            <select class="form-control" id="platformSelect">
                                <option value="SC">SC</option>
                                <option value="ATV">ATV</option>
                                <option value="CC">CC</option>
                                <!-- 添加其他平台选项 -->
                            </select>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="addStreamer()">确认</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 其他页面内容... -->
    
    
    <!-- 自定义脚本 -->
    <script>
        function addStreamer() {
            // 获取输入框和下拉框的值
            var streamerName = document.getElementById('streamerName').value;
            var platform = document.getElementById('platformSelect').value;

            // 构造消息
            var message = {
				operation: 'addStreamer',
                username: streamerName,
                website: platform
            };
            // 使用 fetch 发送消息给服务器
            fetch('/add_streamer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(message),
            })
            .then(response => response.json())
            .then(data => {
                // 处理服务器响应
                // alert(data.message);
				location.reload();
                // 这里可以更新页面内容或执行其他操作
            })
            .catch((error) => {
                console.error('Error:', error);
            });


            // 关闭模态框
            $('#addStreamerModal').modal('hide');
        }

		// 新增的停止按钮点击事件处理函数
	    function toggleStreamer(username, action) {
        // 显示或隐藏对应的按钮
        if (action === 'stop') {
            document.getElementById('stopBtn_' + username).style.display = 'none';
            document.getElementById('startBtn_' + username).style.display = 'inline-block';
        } else if (action === 'start') {
            document.getElementById('startBtn_' + username).style.display = 'none';
            document.getElementById('stopBtn_' + username).style.display = 'inline-block';
        }

        // 在这里添加发送消息给服务器的逻辑
        var message = {
            operation: action,
            username: username
        };
        fetch('/toggle_streamer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(message),
        })
        .then(response => response.json())
        .then(data => {
            // 处理服务器响应
            // alert(data.message);
			location.reload();
            // 这里可以更新页面内容或执行其他操作
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }


    // 新增的移除按钮点击事件处理函数
    function removeStreamer(username) {
        var message = {
            operation: 'removeStreamer',
            username: username
        };
        // 使用 fetch 发送消息给服务器
        fetch('/remove_streamer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(message),
        })
        .then(response => response.json())
        .then(data => {
            // 处理服务器响应
            // alert(data.message);
			location.reload();
            // 这里可以更新页面内容或执行其他操作
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }
    </script>

    <h1>直播下载任务状态</h1>
    <table border="1">
        <tr>
            <th>直播网站</th>
            <th>主播名字</th>
            <th>是否开始监控任务</th>
            <th>直播间状态</th>
            <th>停止录像</th>
            <th>移除主播</th>
        </tr>
        {% for streamer in streamers %}
            <tr>
                <td>{{ streamer.site }}</td>
                <td><a href="{{ url_for('recordings', user=streamer.username, site=streamer.site) }}">{{ streamer.username }}</a></td>
                <td><a href="#" onclick="togglerunning('{{ streamer.username }}')">{{ streamer.running }}</a></td>
                <td><a href="#" onclick="refreshstatus('{{ streamer.username }}')">{{ streamer.status() }}</a></td>
				<td>
					<!-- 停止按钮 -->
					<button id="stopBtn_{{ streamer.username }}" type="button" class="btn btn-warning" style="{% if streamer.running %}display:inline-block;{% else %}display:none;{% endif %}" onclick="toggleStreamer('{{ streamer.username }}', 'stop')">停止</button>
					<!-- 开始按钮，初始时设为不可见 -->
					<button id="startBtn_{{ streamer.username }}" type="button" class="btn btn-success" style="{% if not streamer.running %}display:inline-block;{% else %}display:none;{% endif %}" onclick="toggleStreamer('{{ streamer.username }}', 'start')">开始</button>
				</td>
				<td>
					<!-- 移除按钮 -->
					<button type="button" class="btn btn-danger" onclick="removeStreamer('{{ streamer.username }}')">移除</button>
				</td>
			</tr>
			{% endfor %}
    </table>
</body>
</html>
